services:
  mysql:
    image: mysql:8.0
    container_name: highlightiq-mysql
    environment:
      MYSQL_DATABASE: highlightiq
      MYSQL_USER: highlightiq
      MYSQL_PASSWORD: highlightiq_pass
      MYSQL_ROOT_PASSWORD: root_pass
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    image: mahdialkak/highlightiq-api:latest
    container_name: highlightiq-api
    environment:
      DB_HOST: mysql
      DB_PORT: "3306"
      DB_NAME: highlightiq
      DB_USER: highlightiq
      DB_PASS: highlightiq_pass
      JWT_SECRET: ${JWT_SECRET}
      RECORDINGS_DIR: /data/recordings
      CLIPS_DIR: /data/clips
      CLIPS_BASE_URL: ${CLIPS_BASE_URL}
      N8N_WEBHOOK_SECRET: ${N8N_WEBHOOK_SECRET}
      N8N_PUBLISH_WEBHOOK_URL: ${N8N_PUBLISH_WEBHOOK_URL}
      CLIPPER_URL: http://clipper:8090
    volumes:
      - recordings_data:/data/recordings
      - clips_data:/data/clips
    depends_on:
      mysql:
        condition: service_healthy
    expose:
      - "8080"

  clipper:
    image: mahdialkak/highlightiq-clipper:latest
    container_name: highlightiq-clipper
    volumes:
      - recordings_data:/data/recordings
    expose:
      - "8090"

  web:
    image: mahdialkak/highlightiq-web:latest
    container_name: highlightiq-web
    ports:
      - "80:80"
    depends_on:
      - api

  n8n:
    image: n8nio/n8n:latest
    container_name: highlightiq-n8n
    environment:
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=${N8N_WEBHOOK_URL}
    ports:
      - "5679:5678"
    volumes:
      - n8n_data:/home/node/.n8n

volumes:
  mysql_data:
  recordings_data:
  clips_data:
  n8n_data:
